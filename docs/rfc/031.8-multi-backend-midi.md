# RFC-031.8: Multi-Backend MIDI Support

## Summary

Abstract MIDI output behind a generic `MIDIBackend` interface with environment-specific implementations extracted as separate packages.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    AudioBackend Interface                     │
│        (schedule, cancelAfter, cancelAll, dispose)           │
└─────────────────────────────────────────────────────────────┘
                              ▲
         ┌────────────────────┼────────────────────┐
         │                    │                    │
┌────────▼───────┐   ┌────────▼───────┐   ┌───────▼────────┐
│ WebAudioBackend │   │ WebMIDIBackend │   │ NodeMIDIBackend │
│   (Browser)     │   │   (Browser)    │   │   (Node.js)     │
│   Built-in      │   │ Web MIDI API   │   │   jzz/midi pkg  │
└────────────────┘   └────────────────┘   └────────────────┘
                     @symphonyscript/     @symphonyscript/
                     midi-backend-web     midi-backend-node
```

---

## Package Structure

| Package                             | Environment | Dependency    | Description                                    |
| ----------------------------------- | ----------- | ------------- | ---------------------------------------------- |
| `@symphonyscript/core`              | Any         | None          | Core DSL + Compiler                            |
| `@symphonyscript/live`              | Any         | `core`        | LiveSession, Scheduler, AudioBackend interface |
| `@symphonyscript/midi-backend-web`  | Browser     | `live`        | Web MIDI API implementation                    |
| `@symphonyscript/midi-backend-node` | Node.js     | `live`, `jzz` | Node.js MIDI via jzz                           |

---

## Backend Interface

```typescript
// @symphonyscript/live/backends/types.ts
export interface MIDIBackend extends AudioBackend {
  // Inherited from AudioBackend
  schedule(event: CompiledEvent, audioTime: number): void;
  cancelAfter(beat: number, trackId?: string): void;
  cancelAll(): void;
  getCurrentTime(): number;
  setTempo(bpm: number): void;
  dispose(): void;

  // MIDI-specific
  listOutputs(): Promise<MIDIDevice[]>;
  selectOutput(deviceId: string): Promise<boolean>;
  getSelectedOutput(): MIDIDevice | null;
}

export interface MIDIDevice {
  id: string;
  name: string;
  manufacturer?: string;
}
```

---

## Implementation Details

### WebMIDIBackend (Browser)

```typescript
// @symphonyscript/midi-backend-web/src/index.ts
import type { MIDIBackend, MIDIDevice } from "@symphonyscript/live";

export class WebMIDIBackend implements MIDIBackend {
  private access: MIDIAccess | null = null;
  private output: MIDIOutput | null = null;

  static async isSupported(): Promise<boolean> {
    return typeof navigator !== "undefined" && "requestMIDIAccess" in navigator;
  }

  async init(): Promise<boolean> {
    if (!(await WebMIDIBackend.isSupported())) {
      console.warn("Web MIDI API not available");
      return false;
    }

    try {
      this.access = await navigator.requestMIDIAccess();
      return true;
    } catch (err) {
      console.error("MIDI access denied:", err);
      return false;
    }
  }

  async listOutputs(): Promise<MIDIDevice[]> {
    if (!this.access) return [];
    return Array.from(this.access.outputs.values()).map((o) => ({
      id: o.id,
      name: o.name ?? "Unknown",
      manufacturer: o.manufacturer,
    }));
  }

  // ... rest of implementation
}
```

### NodeMIDIBackend (Node.js)

```typescript
// @symphonyscript/midi-backend-node/src/index.ts
import type { MIDIBackend, MIDIDevice } from "@symphonyscript/live";
import JZZ from "jzz";

export class NodeMIDIBackend implements MIDIBackend {
  private midi: any = null;
  private output: any = null;

  static async isSupported(): Promise<boolean> {
    return (
      typeof process !== "undefined" && process.versions?.node !== undefined
    );
  }

  async init(): Promise<boolean> {
    try {
      this.midi = await JZZ();
      return true;
    } catch (err) {
      console.error("JZZ initialization failed:", err);
      return false;
    }
  }

  async listOutputs(): Promise<MIDIDevice[]> {
    if (!this.midi) return [];
    const info = this.midi.info();
    return info.outputs.map((o: any, i: number) => ({
      id: String(i),
      name: o.name,
      manufacturer: o.manufacturer,
    }));
  }

  // ... rest of implementation
}
```

---

## Auto-Detection Factory

```typescript
// @symphonyscript/live/src/backends/midi.ts
import type { MIDIBackend } from "./types";

export async function createMIDIBackend(): Promise<MIDIBackend | null> {
  // Try Web MIDI first (browser)
  if (typeof navigator !== "undefined" && "requestMIDIAccess" in navigator) {
    const { WebMIDIBackend } = await import("@symphonyscript/midi-backend-web");
    const backend = new WebMIDIBackend();
    if (await backend.init()) return backend;
  }

  // Try Node.js MIDI
  if (typeof process !== "undefined" && process.versions?.node) {
    try {
      const { NodeMIDIBackend } = await import(
        "@symphonyscript/midi-backend-node"
      );
      const backend = new NodeMIDIBackend();
      if (await backend.init()) return backend;
    } catch {
      // Package not installed
    }
  }

  console.warn("No MIDI backend available");
  return null;
}
```

---

## Usage

```typescript
import { LiveSession } from "@symphonyscript/live";
import { createMIDIBackend } from "@symphonyscript/live/backends/midi";

// Auto-detect environment
const midiBackend = await createMIDIBackend();
if (midiBackend) {
  const outputs = await midiBackend.listOutputs();
  console.log("Available MIDI outputs:", outputs);
  await midiBackend.selectOutput(outputs[0].id);
}

const live = new LiveSession({
  bpm: 120,
  backend: midiBackend ?? "webaudio",
});
```

---

## Dependencies

| Package                             | Peer Dependency          |
| ----------------------------------- | ------------------------ |
| `@symphonyscript/midi-backend-web`  | None (uses Web MIDI API) |
| `@symphonyscript/midi-backend-node` | `jzz`                    |

---

## Verification

- [ ] WebMIDIBackend works in Chrome
- [ ] NodeMIDIBackend works with jzz
- [ ] Auto-detection picks correct backend
- [ ] Fallback to WebAudio when MIDI unavailable
- [ ] Device listing and selection works
