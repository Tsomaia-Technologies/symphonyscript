# RFC-030.1: Export Edge Cases

## Summary

Harden MIDI/MusicXML export with edge case support, matching the robustness of import.

## Gaps Identified

| Issue             | Import                      | Export          | Fix Needed                    |
| ----------------- | --------------------------- | --------------- | ----------------------------- |
| Triplet durations | ✅ `'8t'` recognized        | ⚠️ Untested     | Add triplet type mapping      |
| NoteOp.detune     | ✅ Captured from pitch bend | ⚠️ Not exported | Emit pitch bend event         |
| Round-trip        | —                           | ⚠️ No test      | Add import→export→import test |
| Dotted triplets   | ⚠️ Edge case                | ⚠️ Edge case    | Document as unsupported       |

---

## Task 1: Triplet Duration Export

### MIDI Export (`midi.ts`)

Triplets export correctly because we convert from beats → ticks, not from duration strings.
**No change needed** — just add verification test.

### MusicXML Export (`musicxml.ts`)

The `durationToNoteType()` function needs triplet support:

```typescript
// Current (missing triplets):
const typeMap: Record<string, string> = {
  "1n": "whole",
  "2n": "half",
  "4n": "quarter",
  "8n": "eighth",
  "16n": "16th",
  "32n": "32nd",
};

// Proposed:
const typeMap: Record<string, string> = {
  "1n": "whole",
  "2n": "half",
  "4n": "quarter",
  "8n": "eighth",
  "16n": "16th",
  "32n": "32nd",
  "4t": "quarter",
  "8t": "eighth",
  "16t": "16th", // MusicXML handles triplet grouping
};
```

MusicXML requires `<time-modification>` for triplets:

```xml
<note>
  <pitch>...</pitch>
  <duration>2</duration>
  <type>eighth</type>
  <time-modification>
    <actual-notes>3</actual-notes>
    <normal-notes>2</normal-notes>
  </time-modification>
</note>
```

---

## Task 2: Detune → Pitch Bend Export

### Current Behavior

`NoteOp.detune` (cents) is **not exported** as a MIDI pitch bend event.

### Proposed Fix in `convertCompiledEvent()`:

```typescript
case 'note': {
  const midiNote = noteNameToMidi(event.payload.pitch as string)
  if (midiNote === null) break

  const velocity = Math.round(event.payload.velocity as number)

  // === NEW: Export detune as pitch bend ===
  const detuneCents = event.payload.detune as number | undefined
  if (detuneCents && detuneCents !== 0) {
    // Default range: ±200 cents (±2 semitones)
    const normalized = detuneCents / 200  // -1 to +1
    const midiValue = normalizedPitchBendToMidi(normalized)
    results.push({
      tick,
      data: pitchBend(channel, midiValue)
    })
  }

  // Note On
  results.push({
    tick,
    data: noteOn(channel, midiNote, velocity)
  })

  // Note Off
  const offTick = secondsToTicks(event.startSeconds + event.durationSeconds, tempoMap, ppq)
  results.push({
    tick: offTick,
    data: noteOff(channel, midiNote, 0)
  })

  // === NEW: Reset pitch bend after note ===
  if (detuneCents && detuneCents !== 0) {
    results.push({
      tick: offTick,
      data: pitchBend(channel, 8192)  // Center = no bend
    })
  }
  break
}
```

### MusicXML Detune (Optional)

MusicXML doesn't have a direct pitch bend equivalent. Options:

1. Use `<alter>` fractional values (e.g., `<alter>0.5</alter>` for quarter-tone)
2. Omit detune (document as MIDI-only feature)

**Recommendation:** Omit for now, document as limitation.

---

## Task 3: Round-Trip Verification Test

Add to `export-midi.test.ts`:

```typescript
describe("Round-trip", () => {
  it("import → export → import produces equivalent notes", () => {
    // Create original MIDI
    const original = createSimpleMidiBuffer();

    // Import
    const { clip } = importMidiAsClip(original);

    // Compile and export
    const compiled = compileClip(clip, { bpm: 120 });
    const { buffer } = exportMidi(compiled);

    // Re-import
    const { clip: reimported } = importMidiAsClip(buffer);

    // Compare note counts
    const originalNotes = clip.operations.filter((op) => op.kind === "note");
    const reimportedNotes = reimported.operations.filter(
      (op) => op.kind === "note"
    );

    expect(reimportedNotes.length).toBe(originalNotes.length);

    // Compare pitches
    for (let i = 0; i < originalNotes.length; i++) {
      expect((reimportedNotes[i] as NoteOp).note).toBe(
        (originalNotes[i] as NoteOp).note
      );
    }
  });
});
```

---

## Files Summary

| File                      | Changes                           |
| ------------------------- | --------------------------------- |
| `export/musicxml.ts`      | Add triplet `<time-modification>` |
| `export/midi.ts`          | Export detune as pitch bend       |
| `export-midi.test.ts`     | Add round-trip test               |
| `export-musicxml.test.ts` | Add triplet export test           |

---

## Verification

```bash
npx tsc --noEmit
npm test
```

Tests to add:

1. Triplet MusicXML output contains `<time-modification>`
2. Detune exports as pitch bend event
3. Round-trip note count and pitch match
